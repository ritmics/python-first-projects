import json
import os

ОПАСНЫЕ_ПАТТЕРНЫ = [
    ("' OR '", "SQL инъекция"),
    ("'OR'", "SQL инъекция"),
    ("' --", "SQL комментарий"),
    ("UNION SELECT", "SQL UNION-атака"),
    ("DROP TABLE", "SQL удаление таблиц"),
    ("<script>", "XSS"),
    ("javascript:", "XSS через протокол"),
    ("onerror=", "XSS через события"),
    ("onload=", "XSS через события"),
    ("; rm", "Команда ОС"),
    (";rm", "Команда ОС"),
    ("&&", "Выполнение команд"),
    ("|", "Перенаправление команд"),
    ("`", "Выполнение команд"),
    ("../", "Path traversal"),
    ("..\\", "Path traversal (Windows)"),
]

ЛОГ_ФАЙЛ = "security_logs.json"

def main():
    print("=== ВАЛИДАТОР БЕЗОПАСНОСТИ ===")

    проверок_сессия = 0
    опасных_сессия = 0

    while True:
        print("\nЧто вы хотите сделать?")
        print("1. Проверить текст")
        print("2. Выйти")

        выбор = input("Введите номер: ").strip()

        if выбор == "1":
            был_опасен = проверка_текста()
            проверок_сессия += 1
            if был_опасен:
                опасных_сессия += 1

        elif выбор == "2":
            print(f"\n=== СТАТИСТИКА СЕССИИ ===")
            print(f"Проверок выполнено: {проверок_сессия}")
            print(f"Опасных вводов: {опасных_сессия}")
            if проверок_сессия > 0:
                процент = (опасных_сессия / проверок_сессия) * 100
                print(f"Процент опасных: {процент:.1f}%")

            print("Выход из программы.")
            break
        else:
            print("Неверный выбор. Попробуйте снова.")

def проверка_текста():
    print("\n--- Проверка текста ---")

    текст = input("Введите текст для проверки: ").strip('"\'')

    if not текст:
        print("Ошибка: текст пустой")
        return False

    угрозы = []
    for паттерн, описание in ОПАСНЫЕ_ПАТТЕРНЫ:
        if паттерн.lower() in текст.lower():
            if описание not in угрозы:
                угрозы.append(описание)

    if угрозы:
        уровень = "НИЗКИЙ"

        if "Команда ОС" in угрозы or "Выполнение команд" in угрозы:
            уровень = "КРИТИЧЕСКИЙ"
        elif "SQL удаление таблиц" in угрозы:
            уровень = "ОЧЕНЬ ВЫСОКИЙ"
        elif "SQL инъекция" in угрозы or "SQL UNION-атака" in угрозы:
            уровень = "ВЫСОКИЙ"
        elif "XSS" in угрозы:
            уровень = "СРЕДНИЙ"

        print(f"НАЙДЕНО: {', '.join(угрозы)}")
        print(f"УРОВЕНЬ ОПАСНОСТИ: {уровень}")
    else:
        print("БЕЗОПАСНО")

    сохранить_результат(текст, угрозы)

    input("\nНажми Enter чтобы продолжить...")
    return len(угрозы) > 0

def сохранить_результат(текст, угрозы):
    результат = "опасно" if угрозы else "безопасно"

    if os.path.exists(ЛОГ_ФАЙЛ):
        with open(ЛОГ_ФАЙЛ, 'r', encoding='utf-8') as f:
            логи = json.load(f)
    else:
        логи = []

    новая_запись = {
        "текст": текст,
        "результат": результат,
        "угрозы": угрозы
    }

    логи.append(новая_запись)

    with open(ЛОГ_ФАЙЛ, 'w', encoding='utf-8') as f:
        json.dump(логи, f, indent=2, ensure_ascii=False)

    print(f"Запись сохранена. Всего проверок: {len(логи)}")

if __name__ == "__main__":
    main()